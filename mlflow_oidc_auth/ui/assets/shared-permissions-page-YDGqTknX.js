import{i as e,o as t,r as n,t as r}from"./button-DJ30HgDO.js";import{n as i,s as a}from"./chunk-EPOLDU6W-BGm2xlSj.js";import{t as o}from"./use-api-CtLXpHJw.js";import{n as s}from"./use-user-D7emtooi.js";import{a as c,b as l,m as u}from"./free-solid-svg-icons-DA-2lxug.js";import{i as d,r as f}from"./create-api-fetcher-CIVcsK43.js";import{o as p}from"./user-service-nbxILwlX.js";import{t as m}from"./page-container-Bc69w3xC.js";import{_ as h,b as g,c as _,d as v,f as y,l as b,s as x,u as S,y as C}from"./entity-service-gglkTfMc.js";import{t as ee}from"./use-all-experiments-CRMAVEnX.js";import{i as w,n as T,r as E,t as D}from"./search-input-B74H8nYS.js";import{t as O}from"./icon-button-B94rCe__.js";import{n as k,t as A}from"./use-toast-CTLGjzBn.js";import{t as j}from"./input-CjHmXOIG.js";import{n as M,r as N,t as P}from"./grant-permission-modal-BSY-HOl3.js";import{t as F}from"./switch-C8sWYSoG.js";import{i as I,n as L,r as te,t as R}from"./use-user-prompt-permissions-9hnZZRtU.js";import{t as ne}from"./use-all-models-BcZzbIhr.js";import{t as z}from"./use-all-prompts-MOkDVcbx.js";var B=t(e(),1);function V({username:e}){let{data:t,isLoading:n,error:r,refetch:i}=o((0,B.useCallback)(t=>e?p(e,t):Promise.reject(Error(`Username is required`)),[e]));return{user:t,isLoading:n,error:r,refetch:i}}const H=({entityKind:e,entityName:t,type:n,isPattern:r=!1,identifier:i})=>{if(r)if(i){if(n===`experiments`)return e===`user`?d.USER_EXPERIMENT_PATTERN_PERMISSION(t,i):d.GROUP_EXPERIMENT_PATTERN_PERMISSION(t,i);if(n===`models`)return e===`user`?d.USER_MODEL_PATTERN_PERMISSION(t,i):d.GROUP_MODEL_PATTERN_PERMISSION(t,i);if(n===`prompts`)return e===`user`?d.USER_PROMPT_PATTERN_PERMISSION(t,i):d.GROUP_PROMPT_PATTERN_PERMISSION(t,i)}else{if(n===`experiments`)return e===`user`?d.USER_EXPERIMENT_PATTERN_PERMISSIONS(t):d.GROUP_EXPERIMENT_PATTERN_PERMISSIONS(t);if(n===`models`)return e===`user`?d.USER_MODEL_PATTERN_PERMISSIONS(t):d.GROUP_MODEL_PATTERN_PERMISSIONS(t);if(n===`prompts`)return e===`user`?d.USER_PROMPT_PATTERN_PERMISSIONS(t):d.GROUP_PROMPT_PATTERN_PERMISSIONS(t)}else if(i){if(n===`experiments`)return e===`user`?d.USER_EXPERIMENT_PERMISSION(t,i):d.GROUP_EXPERIMENT_PERMISSION(t,i);if(n===`models`)return e===`user`?d.USER_MODEL_PERMISSION(t,i):d.GROUP_MODEL_PERMISSION(t,i);if(n===`prompts`)return e===`user`?d.USER_PROMPT_PERMISSION(t,i):d.GROUP_PROMPT_PERMISSION(t,i)}else{if(n===`experiments`)return e===`user`?d.USER_EXPERIMENT_PERMISSIONS(t):d.GROUP_EXPERIMENT_PERMISSIONS(t);if(n===`models`)return e===`user`?d.USER_MODEL_PERMISSIONS(t):d.GROUP_MODEL_PERMISSIONS(t);if(n===`prompts`)return e===`user`?d.USER_PROMPT_PERMISSIONS(t):d.GROUP_PROMPT_PERMISSIONS(t)}throw Error(`Unknown permission type`)};function U({groupName:e}){let{data:t,isLoading:n,error:r,refetch:i}=o((0,B.useCallback)(t=>e===null?Promise.resolve([]):_(e,t),[e]));return{permissions:t??[],isLoading:n,error:r,refresh:i}}function W({groupName:e}){let{data:t,isLoading:n,error:r,refetch:i}=o((0,B.useCallback)(t=>e===null?Promise.resolve([]):y(e,t),[e]));return{permissions:t??[],isLoading:n,error:r,refresh:i}}function re({groupName:e}){let{data:t,isLoading:n,error:r,refetch:i}=o((0,B.useCallback)(t=>e===null?Promise.resolve([]):v(e,t),[e]));return{permissions:t??[],isLoading:n,error:r,refresh:i}}var G=t(n(),1);const K=({type:e,entityKind:t,entityName:n})=>{let{showToast:i}=A(),[a,o]=(0,B.useState)(!1),[s,d]=(0,B.useState)(null),[p,m]=(0,B.useState)(!1),[h,g]=(0,B.useState)(!1),{searchTerm:_,submittedTerm:v,handleInputChange:y,handleSearchSubmit:b,handleClearSearch:x}=w(),S=te({username:t===`user`?n:null}),C=L({username:t===`user`?n:null}),k=R({username:t===`user`?n:null}),j=U({groupName:t===`group`?n:null}),N=W({groupName:t===`group`?n:null}),F=re({groupName:t===`group`?n:null}),{isLoading:I,error:V,refresh:K,permissions:q}=t===`user`?{experiments:S,models:C,prompts:k}[e]:{experiments:j,models:N,prompts:F}[e],{allExperiments:J}=ee(),{allModels:Y}=ne(),{allPrompts:X}=z(),Z=(()=>{if(e===`experiments`){let e=new Set(q.map(e=>e.id));return(J||[]).filter(t=>!e.has(t.id)).map(e=>({label:e.name,value:e.id}))}let t=new Set(q.map(e=>e.name));return e===`models`?(Y||[]).filter(e=>!t.has(e.name)).map(e=>e.name):e===`prompts`?(X||[]).filter(e=>!t.has(e.name)).map(e=>e.name):[]})(),ie=e=>{d(e),o(!0)},Q=()=>{o(!1),d(null)},ae=async r=>{if(!(!n||!s)){m(!0);try{await f(H({entityKind:t,entityName:n,type:e,identifier:`id`in s?String(s.id):s.name}),{method:(t===`user`?s.kind===`user`||s.kind===`service-account`:s.kind===`group`)?`PATCH`:`POST`,body:JSON.stringify({permission:r})}),i(`Permission for ${s.name} has been updated`,`success`),K(),Q()}catch{i(`Failed to update permission`,`error`)}finally{m(!1)}}},$=async(t,r)=>{if(n){m(!0);try{await f(H({entityKind:`group`,entityName:n,type:e,identifier:t}),{method:`POST`,body:JSON.stringify({permission:r})}),i(`Permission for ${e===`experiments`&&J?.find(e=>e.id===t)?.name||t} has been granted`,`success`),K(),g(!1)}catch{i(`Failed to grant permission`,`error`)}finally{m(!1)}}},oe=async r=>{if(n)try{let a=`id`in r?r.id:r.name;await f(H({entityKind:t,entityName:n,type:e,identifier:String(a)}),{method:`DELETE`}),i(`Permission for ${r.name} has been removed`,`success`),K()}catch{i(`Failed to remove permission`,`error`)}},se=[{header:`Name`,render:e=>(0,G.jsx)(`span`,{className:`truncate block`,title:e.name,children:e.name})},{header:`Permission`,render:e=>e.permission},{header:`Kind`,render:e=>e.kind},{header:`Actions`,render:e=>{let n=e.kind===`fallback`,r=t===`user`?e.kind===`user`||e.kind===`service-account`:e.kind===`group`,i=!r||n;return(0,G.jsxs)(`div`,{className:`flex space-x-2`,children:[(0,G.jsx)(O,{icon:i?u:c,title:i?`Add permission`:`Edit permission`,onClick:()=>ie(e)}),(0,G.jsx)(O,{icon:l,title:`Remove permission`,onClick:()=>{oe(e)},disabled:!r})]})},className:`w-24`}],ce=q.filter(e=>e.name.toLowerCase().includes(v.toLowerCase()));return(0,G.jsxs)(G.Fragment,{children:[(0,G.jsx)(T,{isLoading:I,loadingText:`Loading permissions...`,error:V,onRetry:K}),!I&&!V&&(0,G.jsxs)(G.Fragment,{children:[(0,G.jsxs)(`div`,{className:`mt-2 mb-3 flex items-center gap-6`,children:[(0,G.jsx)(D,{value:_,onInputChange:y,onSubmit:b,onClear:x,placeholder:`Search ${e}...`}),t===`group`&&(0,G.jsxs)(r,{variant:`secondary`,onClick:()=>g(!0),disabled:Z.length===0,icon:u,className:`whitespace-nowrap h-8 mb-1 mt-2`,children:[`Add`,` `,e===`experiments`?`experiment`:e===`models`?`model`:`prompt`]})]}),(0,G.jsx)(E,{data:ce,columns:se,searchTerm:v})]}),a&&s&&(0,G.jsx)(M,{isOpen:a,onClose:Q,onSave:ae,item:s,username:n,type:e,isLoading:p},`id`in s?String(s.id):s.name),(0,G.jsx)(P,{isOpen:h,onClose:()=>g(!1),onSave:(e,t)=>$(e,t),title:`Grant ${e===`experiments`?`experiment`:e===`models`?`model`:`prompt`} permissions for ${n}`,label:e===`experiments`?`Experiment`:e===`models`?`Model`:`Prompt`,options:Z,isLoading:p},h?`open`:`closed`)]})},q=({isOpen:e,onClose:t,onSave:n,isLoading:i=!1})=>{let[a,o]=(0,B.useState)(``),[s,c]=(0,B.useState)(100),[l,u]=(0,B.useState)(`READ`),[d,f]=(0,B.useState)({});if(!e)return null;let p=async()=>{let e={},t=!1;if(!a.trim())e.regex=`Regex is required.`,t=!0;else try{new RegExp(a)}catch{e.regex=`Invalid regular expression. Please enter a valid Python regex.`,t=!0}s===void 0||isNaN(s)?(e.priority=`Priority is required.`,t=!0):(!Number.isInteger(s)||s<0)&&(e.priority=`Priority must be a non-negative integer.`,t=!0),f(e),!t&&await n(a,l,s)};return(0,G.jsxs)(k,{isOpen:e,onClose:t,title:`Add New Regex Rule`,children:[(0,G.jsx)(j,{id:`regex-input`,label:`Regex*`,type:`text`,value:a,onChange:e=>{o(e.target.value),d.regex&&f({...d,regex:void 0})},required:!0,placeholder:`Enter Python Regex e.g. (^test_.*)`,error:d.regex,containerClassName:`mb-4`,reserveErrorSpace:!0}),(0,G.jsx)(j,{id:`priority-input`,label:`Priority*`,type:`number`,value:isNaN(s)?``:s,onChange:e=>{c(parseInt(e.target.value,10)),d.priority&&f({...d,priority:void 0})},required:!0,step:`1`,min:`0`,error:d.priority,containerClassName:`mb-4`,reserveErrorSpace:!0}),(0,G.jsx)(N,{id:`permission-level`,label:`Permissions*`,value:l,onChange:e=>u(e),required:!0,containerClassName:`mb-4`}),(0,G.jsxs)(`div`,{className:`flex justify-end space-x-3`,children:[(0,G.jsx)(r,{onClick:t,variant:`ghost`,disabled:i,children:`Cancel`}),(0,G.jsx)(r,{onClick:()=>{p()},variant:`primary`,disabled:i,children:i?`Saving...`:`Save`})]})]})};function J({username:e}){let{data:t,isLoading:n,error:r,refetch:i}=o((0,B.useCallback)(t=>e===null?Promise.resolve([]):h(e,t),[e]));return{permissions:t??[],isLoading:n,error:r,refresh:i}}function Y({username:e}){let{data:t,isLoading:n,error:r,refetch:i}=o((0,B.useCallback)(t=>e===null?Promise.resolve([]):C(e,t),[e]));return{permissions:t??[],isLoading:n,error:r,refresh:i}}function X({username:e}){let{data:t,isLoading:n,error:r,refetch:i}=o((0,B.useCallback)(t=>e===null?Promise.resolve([]):g(e,t),[e]));return{permissions:t??[],isLoading:n,error:r,refresh:i}}function Z({groupName:e}){let{data:t,isLoading:n,error:r,refetch:i}=o((0,B.useCallback)(t=>e===null?Promise.resolve([]):x(e,t),[e]));return{permissions:t??[],isLoading:n,error:r,refresh:i}}function ie({groupName:e}){let{data:t,isLoading:n,error:r,refetch:i}=o((0,B.useCallback)(t=>e===null?Promise.resolve([]):b(e,t),[e]));return{permissions:t??[],isLoading:n,error:r,refresh:i}}function Q({groupName:e}){let{data:t,isLoading:n,error:r,refetch:i}=o((0,B.useCallback)(t=>e===null?Promise.resolve([]):S(e,t),[e]));return{permissions:t??[],isLoading:n,error:r,refresh:i}}const ae=({type:e,entityKind:t,entityName:n})=>{let{showToast:i}=A(),[a,o]=(0,B.useState)(!1),[s,d]=(0,B.useState)(!1),[p,m]=(0,B.useState)(null),[h,g]=(0,B.useState)(!1),{searchTerm:_,submittedTerm:v,handleInputChange:y,handleSearchSubmit:b,handleClearSearch:x}=w(),S=J({username:t===`user`?n:null}),C=Y({username:t===`user`?n:null}),ee=X({username:t===`user`?n:null}),k=Z({groupName:t===`group`?n:null}),j=ie({groupName:t===`group`?n:null}),N=Q({groupName:t===`group`?n:null}),{isLoading:P,error:F,refresh:I,permissions:L}=t===`user`?{experiments:S,models:C,prompts:ee}[e]:{experiments:k,models:j,prompts:N}[e],te=e=>{m(e),o(!0)},R=()=>{o(!1),m(null)},ne=async(r,a,o)=>{if(!(!n||!p)){g(!0);try{let s=String(p.id);await f(H({entityKind:t,entityName:n,type:e,isPattern:!0,identifier:String(s)}),{method:`PATCH`,body:JSON.stringify({regex:a??p.regex,priority:o??p.priority,permission:r})}),i(`Permission for ${a??p.regex} has been updated`,`success`),I(),R()}catch{i(`Failed to update permission`,`error`)}finally{g(!1)}}},z=async(r,a,o)=>{if(n){g(!0);try{await f(H({entityKind:t,entityName:n,type:e,isPattern:!0}),{method:`POST`,body:JSON.stringify({regex:r,permission:a,priority:o})}),i(`Regex rule "${r}" has been added`,`success`),I(),d(!1)}catch{i(`Failed to add regex rule`,`error`)}finally{g(!1)}}},V=async r=>{if(n)try{let a=String(r.id);await f(H({entityKind:t,entityName:n,type:e,isPattern:!0,identifier:String(a)}),{method:`DELETE`}),i(`Regex rule has been removed`,`success`),I()}catch{i(`Failed to remove permission`,`error`)}},U=[{header:`Regex Pattern`,render:e=>(0,G.jsx)(`span`,{className:`truncate block`,title:e.regex,children:e.regex})},{header:`Permission`,render:e=>e.permission},{header:`Priority`,render:e=>e.priority},{header:`Actions`,render:e=>(0,G.jsxs)(`div`,{className:`flex space-x-2`,children:[(0,G.jsx)(O,{icon:c,title:`Edit pattern permission`,onClick:()=>te(e)}),(0,G.jsx)(O,{icon:l,title:`Remove pattern permission`,onClick:()=>{V(e)}})]}),className:`w-24`}],W=L.filter(e=>e.regex?.toLowerCase().includes(v.toLowerCase()));return(0,G.jsxs)(G.Fragment,{children:[(0,G.jsx)(T,{isLoading:P,loadingText:`Loading permissions...`,error:F,onRetry:I}),!P&&!F&&(0,G.jsxs)(G.Fragment,{children:[(0,G.jsxs)(`div`,{className:`mt-2 mb-3 flex items-center gap-6`,children:[(0,G.jsx)(D,{value:_,onInputChange:y,onSubmit:b,onClear:x,placeholder:`Search ${e}...`}),(0,G.jsx)(r,{variant:`secondary`,onClick:()=>d(!0),icon:u,className:`whitespace-nowrap h-8 mb-1 mt-2`,children:`Add Regex`})]}),(0,G.jsx)(E,{data:W,columns:U,searchTerm:v})]}),a&&p&&(0,G.jsx)(M,{isOpen:a,onClose:R,onSave:ne,item:p,username:n,type:e,isLoading:h},p.id),s&&(0,G.jsx)(q,{isOpen:s,onClose:()=>d(!1),onSave:z,isLoading:h})]})};var $=`_mlflow_is_regex_mode`;const oe=({type:e,baseRoute:t,entityKind:n})=>{let{username:r,groupName:o}=a(),c=(n===`user`?r:o)||null,{currentUser:l}=s(),{user:u,refetch:d}=V({username:n===`user`&&l?.is_admin?c:null}),[f,p]=(0,B.useState)(()=>localStorage.getItem($)===`true`);return(0,B.useEffect)(()=>{localStorage.setItem($,f.toString())},[f]),c?(0,G.jsxs)(m,{title:f?`Regex Permissions for ${c}`:`Permissions for ${c}`,children:[(0,G.jsx)(`div`,{className:`flex items-end gap-6`,children:n===`user`&&l?.is_admin&&(0,G.jsx)(I,{username:c,passwordExpiration:u?.password_expiration,onTokenGenerated:d})}),(0,G.jsxs)(`div`,{className:`flex justify-between items-center border-b border-btn-secondary-border dark:border-btn-secondary-border-dark mb-3`,children:[(0,G.jsx)(`div`,{className:`flex space-x-4`,children:[{id:`experiments`,label:`Experiments`},{id:`models`,label:`Models`},{id:`prompts`,label:`Prompts`}].map(n=>(0,G.jsx)(i,{to:`${t}/${c}/${n.id}`,className:`py-2 px-4 border-b-2 font-medium text-sm transition-colors duration-200 ${e===n.id?`border-btn-primary text-btn-primary dark:border-btn-primary-dark dark:text-btn-primary-dark`:`border-transparent text-text-primary dark:text-text-primary-dark hover:text-text-primary-hover dark:hover:text-text-primary-hover-dark hover:border-btn-secondary-border dark:hover:border-btn-secondary-border-dark`}`,children:n.label},n.id))}),l?.is_admin&&(0,G.jsx)(F,{checked:f,onChange:p,label:`Regex Mode`,className:`mr-5`,labelClassName:`py-2 px-2 font-medium text-sm transition-colors duration-200 ${f?`text-btn-primary dark:text-btn-primary-dark`:`text-text-primary hover:text-text-primary-hover dark:hover:text-text-primary-hover-dark hover:border-btn-secondary-border dark:hover:border-btn-secondary-border-dark`}`})]}),f?(0,G.jsx)(ae,{type:e,entityKind:n,entityName:c}):(0,G.jsx)(K,{type:e,entityKind:n,entityName:c})]}):(0,G.jsx)(m,{title:`Error`,children:(0,G.jsxs)(`div`,{className:`p-4 text-red-500`,children:[n===`user`?`Username`:`Group name`,` is required.`]})})};export{oe as t};